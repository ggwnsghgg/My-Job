# 2025-09-14 작업 정리

## 개요
- 바코드 No Backorder 흐름 안정화 및 배치 처리 개선
- 유통기한(Expiry) 관련 예약 Fallback 보완
- e‑Tax 매칭 위저드 잔액 계산/정렬/표시 개선
- Barobill 현금영수증 취소 키(CancelMgtKey) 중복 대응 추가

## 상세 변경
### Barcode (ka_stock_barcode_no_backorder)
- Validate 루프 차단: 커스텀 다이얼로그에서 `super.validate()` 직행, 필요 시 `showBackOrderDialog` 일시 비활성.
- 배치 처리: 선택 픽킹/배치의 ID 컨텍스트 정확히 전달.
- 예약만 존재하는 라인 자동 완료, 예약/미예약 분기 로깅 강화.
- 서버 로그: `stock.picking.button_validate()` / `stock.backorder.confirmation` ENTER/EXIT 로그 추가.

### Sales Expiry (ka_sale_product_expiry)
- `_update_reserved_quantity()` 보완: 강제 lot로 예약 후 잔여는 허용 lot 없으면 코어 FEFO로 Fallback.
- `_prepare_move_line_vals()` 오타 수정(`forced_lot_id`).

### e‑Tax 매칭 (linkup‑etax)
- 잔액 계산 보정: e‑Tax 매칭합을 벤더 금액 한도로 캡핑(min)하여 합산 → 과다 입력 시에도 잔액 5원 등 정확히 노출.
- 검색/정렬: 잔액(미매칭) 있는 문서만, 잔액 큰 순으로 상단 노출. 부분 매칭된 문서도 표시.
- 표시 컬럼: `Matched With`(어떤 전표와 얼마 매칭) 추가.

### Barobill 현금영수증 취소 (lu_etax_barobill)
- `CancelMgtKey` 항상 유니크 생성(타임스탬프 접미). 중복 오류 시 새 키로 1회 재시도.

## 테스트 메모
- No Backorder: 일부 라인만 완료 상태에서 Validate → 백오더 없이 Done, 서버 로그 확인.
- Expiry Fallback: SO 라인 강제 lot 부족 시 잔여가 다른 lot에서 예약되는지 확인.
- 매칭 위저드: 2,005 → 2,000 매칭 후 잔액 5원이 상단 노출, `Matched With` 표시 확인.
- CashBill 취소: 반복 취소 시 중복키 오류 없이 처리 및 상태 동기화.

## 후속 제안
- 발행/취소 재시도·상태 동기화 정책 문서화 및 크론 보강.
- 금액/타입 매핑 헬퍼 일원화(바로빌/팝빌 공유 로직).
